# Task # 3

## Requirements

–ó–∞–¥–∞–Ω–∏–µ 3

(–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é)

–ù–∞–ø–∏—Å–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î:

1. –ü–æ—Å—á–∏—Ç–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Å—Ç–æ–≤ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –∑–∞–¥–∞–Ω–Ω—ã–º ID;
2. –í—ã–±—Ä–∞—Ç—å N –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤, –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –≤ –ø–æ—Ä—è–¥–∫–µ —É–±—ã–≤–∞–Ω–∏—è –¥–∞—Ç—ã —Å–æ–∑–¥–∞–Ω–∏—è;
3. –í—ã–±—Ä–∞—Ç—å N –ø–æ—Å—Ç–æ–≤ –≤ —Å—Ç–∞—Ç—É—Å–µ "–æ–∂–∏–¥–∞–µ—Ç –ø—É–±–ª–∏–∫–∞—Ü–∏–∏", –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –≤ –ø–æ—Ä—è–¥–∫–µ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—è –¥–∞—Ç—ã —Å–æ–∑–¥–∞–Ω–∏—è;
4. –ù–∞–π—Ç–∏ N –Ω–µ–¥–∞–≤–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ —Ç—ç–≥–∞ –¥–ª—è K —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–≤ –∫–∞–∂–¥–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ L –ø–æ—Å—Ç–æ–≤).
5. –ù–∞–π—Ç–∏ N –ø–æ—Å—Ç–æ–≤ —Å –Ω–∞–∏–±–æ–ª—å—à–∏–º —Ä–µ–π—Ç–∏–Ω–≥–æ–º –∑–∞ –¥–µ–Ω—å/–º–µ—Å—è—Ü/–≥–æ–¥.
6. –û—Ü–µ–Ω–∏—Ç—å –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ (–Ω–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö) –∏ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–ª–∞–Ω –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤.
7. –°–æ–∫—Ä–∞—Ç–∏—Ç—å –≤—Ä–µ–º—è –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤, –∏—Å–ø–æ–ª—å–∑—É—è –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –∏–Ω–¥–µ–∫—Å—ã. –°—Ä–∞–≤–Ω–∏—Ç—å –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∏ –ø–ª–∞–Ω –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω–¥–µ–∫—Å–æ–≤.
8. –û—Ü–µ–Ω–∏—Ç—å —Ä–∞–∑–º–µ—Ä –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤. –ü—Ä–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ - —Å–æ–∫—Ä–∞—Ç–∏—Ç—å —Ä–∞–∑–º–µ—Ä —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤.

## Solution

## 1. –ü–æ—Å—á–∏—Ç–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Å—Ç–æ–≤ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –∑–∞–¥–∞–Ω–Ω—ã–º ID;

```sql
--8<-- "sql/task3/queries/query3_1.sql"
```

```go
--8<-- "golang/task3_1_test.go"
```

## 2. –í—ã–±—Ä–∞—Ç—å N –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤, –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –≤ –ø–æ—Ä—è–¥–∫–µ —É–±—ã–≤–∞–Ω–∏—è –¥–∞—Ç—ã —Å–æ–∑–¥–∞–Ω–∏—è;

```sql
--8<-- "sql/task3/queries/query3_2.sql"
```

```go
--8<-- "golang/task3_2_test.go"
```

## 3. –í—ã–±—Ä–∞—Ç—å N –ø–æ—Å—Ç–æ–≤ –≤ —Å—Ç–∞—Ç—É—Å–µ "–æ–∂–∏–¥–∞–µ—Ç –ø—É–±–ª–∏–∫–∞—Ü–∏–∏", –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –≤ –ø–æ—Ä—è–¥–∫–µ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—è –¥–∞—Ç—ã —Å–æ–∑–¥–∞–Ω–∏—è;

```sql
--8<-- "sql/task3/queries/query3_3.sql"
```

```go
--8<-- "golang/task3_3_test.go"
```

## 4. –ù–∞–π—Ç–∏ N –Ω–µ–¥–∞–≤–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ —Ç—ç–≥–∞ –¥–ª—è K —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–≤ –∫–∞–∂–¥–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ L –ø–æ—Å—Ç–æ–≤).

```sql
--8<-- "sql/task3/queries/query3_4.sql"
```

```go
--8<-- "golang/task3_4_test.go"
```

## 5. –ù–∞–π—Ç–∏ N –ø–æ—Å—Ç–æ–≤ —Å –Ω–∞–∏–±–æ–ª—å—à–∏–º —Ä–µ–π—Ç–∏–Ω–≥–æ–º –∑–∞ –¥–µ–Ω—å/–º–µ—Å—è—Ü/–≥–æ–¥.

```sql
--8<-- "sql/task3/queries/query3_5.sql"
```

```go
--8<-- "golang/task3_5_test.go"
```

# 6. –û—Ü–µ–Ω–∏—Ç—å –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ (–Ω–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö) –∏ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–ª–∞–Ω –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤.

–í—ã–ø–æ–ª–Ω–∏–º –≤–º–µ—Å—Ç–µ —Å 7–º –ø—É–Ω–∫—Ç–æ–º

# 7. –°–æ–∫—Ä–∞—Ç–∏—Ç—å –≤—Ä–µ–º—è –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤, –∏—Å–ø–æ–ª—å–∑—É—è –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –∏–Ω–¥–µ–∫—Å—ã. –°—Ä–∞–≤–Ω–∏—Ç—å –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∏ –ø–ª–∞–Ω –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω–¥–µ–∫—Å–æ–≤.

–í—ã–ø–æ–ª–Ω–∏–º –≤–º–µ—Å—Ç–µ —Å 8 –ø—É–Ω–∫—Ç–æ–º.1.1 –î—Ä–µ–≤–Ω–∏–µ –∏–Ω–¥–µ–∫—Å—ã, –≤–µ—Ä—Å–∏—è –ø–µ—Ä–≤–∞—è

## 7.1 –∏—Ç–µ—Ä–∞—Ü–∏—è –ø–µ—Ä–≤–∞—è, –î—Ä–µ–≤–Ω–∏–µ –∏–Ω–¥–µ–∫—Å—ã

- CREATE UNIQUE INDEX CONCURRENTLY idx_post_id ON post USING BTREE (id);
- CREATE INDEX CONCURRENTLY idx_post_author_id ON post USING BTREE (author_id);
- CREATE INDEX CONCURRENTLY idx_post_created ON post USING BTREE (created_at);
- CREATE INDEX CONCURRENTLY idx_post_edition_post_id ON post_edition USING BTREE (post_id);
- CREATE INDEX CONCURRENTLY idx_post_edition_tags ON post_edition USING GIN (tags);
- CREATE INDEX CONCURRENTLY idx_post_edition_edited ON post_edition USING BTREE (edited_at);
- CREATE INDEX CONCURRENTLY idx_expression_post_approval_change_coal ON post_approval(COALESCE(change,0));
- CREATE INDEX CONCURRENTLY idx_expression_post_approval_created_at_coal ON post_approval(COALESCE(created_at,'2022-11-20'));

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ —Ç–µ—Å—Ç–∞–º**:

params=dbname=skeakexw_indexes users=50000 posts=2500000 post_visits=500000 post_editions=500000

params=dbname=skeakexw_indexless users=50000 posts=2500000 post_visits=500000 post_editions=500000


| test_number | without indexes time | with indexes time | comment                                                   |
| ------------- | ---------------------- | ------------------- | ----------------------------------------------------------- |
| test3_1     | 13.173475ms          | 62.62767ms        |                                                           |
| test3_2     | 494.908922ms         | 236.153827ms      | –ú–æ–≥–ª–æ –±—ã—Ç—å –∏ –ª—É—á—à–µ                         |
| test3_3     | 25.677738ms          | 118.605085ms      |                                                           |
| test3_4     | 182.22424ms          | 177.981498ms      | –ú–æ–≥–ª–æ –±—ã—Ç—å –∏ –ª—É—á—à–µ                         |
| test3_5     | 1.850409686s         | 1.82764835s       | –°–æ–≤—Å–µ–º —É–∂–∞—Å–Ω–æ. –ù–∞–¥–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å    |
| test4_1     | 93.087218ms          | 81.036566ms       |                                                           |
| test4_2     | 83.113015ms          | 100.553016ms      |                                                           |
| test4_3     | 230.356592ms         | 228.807421ms      | –ú–æ–≥–ª–æ –±—ã—Ç—å –∏ –ª—É—á—à–µ                         |
| test4_4     | 394.721926ms         | 423.217393ms      | –ü–ª–æ—Ö–æ–≤–∞—Ç–æ. –ù–∞–¥–æ —É–ª—É—á—à–∏—Ç—å —Ç–æ—á–Ω–æ. |
| test4_5     | 14.384774ms          | 15.459392ms       |                                                           |
| test4_6     | 547.817848ms         | 581.175276ms      | –ü–ª–æ—Ö–æ–≤–∞—Ç–æ. –ù–∞–¥–æ —É–ª—É—á—à–∏—Ç—å —Ç–æ—á–Ω–æ  |

## 7.2 –∏—Ç–µ—Ä–∞—Ü–∏—è 2, –ø–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

–î–æ–±–∞–≤–∏–ª–∏ –∏–Ω–¥–µ–∫—Å—ã –≤ —Ä–∞–∑–Ω—ã–µ –º–µ—Å—Ç–∞

- CREATE INDEX CONCURRENTLY idx_post_author_id ON post USING BTREE (author_id); -- 3_1 // replace to HASH
- CREATE INDEX CONCURRENTLY idx_post_created ON post USING BTREE (created_at); -- 3_2, 3_3, 3_5
- CREATE INDEX CONCURRENTLY idx_post_status ON post USING BTREE (status); -- 3_3
- CREATE INDEX CONCURRENTLY idx_post_rating ON post USING BTREE (rating); -- 4_3 ORDER
- CREATE INDEX CONCURRENTLY idx_post_edition_post_id ON post_edition USING HASH (post_id); -- 3_4, 4_2
- CREATE INDEX CONCURRENTLY idx_post_edition_tags ON post_edition USING GIN (tags); -- 3_4
- CREATE INDEX CONCURRENTLY idx_post_edition_edited ON post_edition USING BTREE (edited_at); -- 3_4 ORD
- CREATE INDEX CONCURRENTLY idx_post_edition_user_id ON post_edition USING HASH (user_id); -- 4_2
- CREATE INDEX CONCURRENTLY idx_expression_post_approval_change_coal ON post_approval(COALESCE(change,0)); -- 3_5
- CREATE INDEX CONCURRENTLY idx_post_approval_post_id ON post_approval USING HASH (post_id); -- 3_5
- CREATE INDEX CONCURRENTLY idx_post_visits_day_date ON post_visits_per_day USING BTREE (day_date); -- 4_1 LIKE
- CREATE INDEX CONCURRENTLY idx_post_visits_visits ON post_visits_per_day USING BTREE (visits); -- 4_1 ORDER
- CREATE INDEX CONCURRENTLY idx_post_visits_post_id ON post_visits_per_day USING HASH (post_id); -- 4_6
- CREATE INDEX CONCURRENTLY idx_user_ratings_ratings ON user_ratings USING BTREE (rating); -- 4_5

## 5.2.2 –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

params=dbname=hpemdfwd_indexes users=50000 posts=2500000 post_visits=500000 post_editions=500000

params=dbname=hpemdfwd_indexless users=50000 posts=2500000 post_visits=500000 post_editions=500000
params=dbname=klvacuzr_indexes


| test_number | without indexes time | with indexes time | comment                                                           |
| ------------- | ---------------------- | ------------------- | ------------------------------------------------------------------- |
| test3_1     | 65.486489ms          | 63.537003ms       |                                                                   |
| test3_2     | 3.391107918s         | 6.038363ms        | —Å –∏–Ω–¥–µ–∫—Å–æ–º —Å—Ç–∞–ª–æ –Ω–∞–º–Ω–æ–≥–æ –ª—É—á—à–µ.         |
| test3_3     | 245.633943ms         | 123.074054ms      |                                                                   |
| test3_4     | 225.958538ms         | 192.053567ms      |                                                                   |
| test3_5     | 2.87305117s          | 1.365926592s      | –û—á–µ–Ω—å –ø–ª–æ—Ö–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç.                       |
| test4_1     | 45.891744ms          | 77.027456ms       |                                                                   |
| test4_2     | 45.254657ms          | 96.388864ms       |                                                                   |
| test4_3     | 224.282966ms         | 220.340384ms      |                                                                   |
| test4_4     | 374.433174ms         | 375.223436ms      | –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, –Ω–æ –º–æ–≥–ª–æ –±—ã—Ç—å –∏ –ª—É—á—à–µ |
| test4_5     | 6.024233ms           | 17.840107ms       |                                                                   |
| test4_6     | 186.814461ms         | 498.238269ms      | —Å—Ç–∞–ª–æ —Ö—É–∂–µ —Å –∏–Ω–¥–µ–∫—Å–æ–º?                          |

## 5.3.1 –ü–æ–ø—Ä–æ–±—É–µ–º —É–ª—É—á—à–∏—Ç—å —Ç–µ—Å—Ç 3_5

EXPLAIN ANALYZE SELECT
post.id,
SUM(COALESCE(change,0)) as calculated_rating,
post.created_at as created
FROM post
LEFT JOIN post_approval pr ON pr.post_id = post.id
WHERE post.created_at BETWEEN NOW() - interval '3 year' and NOW()
GROUP BY post.id
ORDER BY created DESC
LIMIT 50


| QUERY PLAN                                                                                                                              |
| ----------------------------------------------------------------------------------------------------------------------------------------- |
| Limit  (cost=247788.18..247788.31 rows=50 width=20) (actual time=2202.961..2202.968 rows=50 loops=1)                                    |
| ->  Sort  (cost=247788.18..254038.18 rows=2500000 width=20) (actual time=2197.929..2197.934 rows=50 loops=1)                            |
| Sort Key: post.created_at DESC                                                                                                          |
| Sort Method: top-N heapsort  Memory: 31kB                                                                                               |
| ->  GroupAggregate  (cost=113.70..164739.98 rows=2500000 width=20) (actual time=0.052..1961.966 rows=2500000 loops=1)                   |
| Group Key: post.id                                                                                                                      |
| ->  Merge Left Join  (cost=113.70..120989.98 rows=2500000 width=14) (actual time=0.046..1420.538 rows=2500000 loops=1)                  |
| Merge Cond: (post.id = pr.post_id)                                                                                                      |
| ->  Index Scan using post_pkey on post  (cost=0.43..114602.26 rows=2500000 width=12) (actual time=0.035..1220.553 rows=2500000 loops=1) |
| Filter: ((created_at <= now()) AND (created_at >= (now() - '3 years'::interval)))                                                       |
| ->  Sort  (cost=113.27..117.34 rows=1630 width=6) (actual time=0.008..0.009 rows=0 loops=1)                                             |
| Sort Key: pr.post_id                                                                                                                    |
| Sort Method: quicksort  Memory: 25kB                                                                                                    |
| ->  Seq Scan on post_approval pr  (cost=0.00..26.30 rows=1630 width=6) (actual time=0.003..0.003 rows=0 loops=1)                        |
| Planning Time: 0.192 ms                                                                                                                 |
| JIT:                                                                                                                                    |
| Functions: 15                                                                                                                           |
| Options: Inlining false, Optimization false, Expressions true, Deforming true                                                           |
| Timing: Generation 1.048 ms, Inlining 0.000 ms, Optimization 0.251 ms, Emission 4.646 ms, Total 5.945 ms                                |
| Execution Time: 2204.100 ms                                                                                                             |

–°—É–¥—è –ø–æ Explain –ø–ª–∞–Ω—É, –±–æ–ª—å—à–∏–Ω—Å—Ç–≤—É —Ü–µ–Ω—ã –∑–∞—Ç—Ä–∞—á–µ–Ω–æ –Ω–∞ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É –ø–æ –∫–ª—é—á—É post.created_at DESC ü§î
CREATE INDEX CONCURRENTLY idx_post_created ON post USING BTREE (created_at);
idx_post_created CREATE INDEX idx_post_created ON public.post USING btree (created_at)
post_pkey CREATE UNIQUE INDEX post_pkey ON public.post USING btree (id)
idx_post_approval_post_id CREATE INDEX idx_post_approval_post_id ON public.post_approval USING hash (post_id) # post.id = pr.post_id Merge cond

–£–ª—É—á—à–∏–ª —Å–∫–æ—Ä–æ—Å—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è 100–º—Å.
–ó–∞–±—ã–ª —á—Ç–æ –¥–æ–±–∞–≤–ª—è–ª —É–∂–µ –¥–µ–Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—é —Ä–µ–π—Ç–∏–Ω–≥–∞ –∫ –ø–æ—Å—Ç—É :)

```sql
SELECT
id,
rating,
created_at
FROM post
WHERE created_at BETWEEN NOW() - interval '1 year' and NOW()
-- WHERE created_at BETWEEN NOW() - interval '1 month' and NOW()
-- WHERE created_at BETWEEN NOW() - interval '1 day' and NOW()
ORDER BY created_at DESC
LIMIT :N
```


| test_number | without indexes time | with indexes time | comment                                                                           |
| ------------- | ---------------------- | ------------------- | ----------------------------------------------------------------------------------- |
| test3_1     | 65.486489ms          | 63.537003ms       |                                                                                   |
| test3_2     | 217ms                | 30ms              |                                                                                   |
| test3_3     | 140ms                | 8ms               |                                                                                   |
| test3_4     | 254ms                | 240ms             |                                                                                   |
| test3_5     | 353ms                | 11ms              |                                                                                   |
| test4_1     | 97ms                 | 54ms              |                                                                                   |
| test4_2     | 122ms                | 89ms              |                                                                                   |
| test4_3     | 768ms                | 300m              |                                                                                   |
| test4_4     | 592ms                | 500ms             | –∑–¥–µ—Å—å –Ω–µ–º–Ω–æ–≥–æ –¥–æ–ª–≥–æ–≤–∞—Ç–æ, –ø–æ–ø—Ä–æ–±—É–µ–º —É–ª—É—á—à–∏—Ç—å |
| test4_5     | 17ms                 | 8ms               |                                                                                   |
| test4_6     | 677ms                | 274ms             |                                                                                   |

test 4_4

```sql
EXPLAIN ANALYZE SELECT u.id, u.birth_date::date, SUM(p.rating) as summed_rating FROM post p
JOIN user_ u ON u.id = p.author_id
WHERE (NOW()::date - u.birth_date::date) < 365 * 1
GROUP BY u.id
ORDER BY summed_rating DESC
LIMIT 50
```


| QUERY PLAN                                                                                                                  |
| ----------------------------------------------------------------------------------------------------------------------------- |
| Limit  (cost=40585.83..40585.96 rows=50 width=16) (actual time=572.909..572.982 rows=50 loops=1)                            |
| ->  Sort  (cost=40585.83..40627.50 rows=16667 width=16) (actual time=572.908..572.978 rows=50 loops=1)                      |
| Sort Key: (sum(p.rating)) DESC                                                                                              |
| Sort Method: top-N heapsort  Memory: 29kB                                                                                   |
| ->  Finalize HashAggregate  (cost=39865.50..40032.17 rows=16667 width=16) (actual time=562.265..568.745 rows=49873 loops=1) |
| Group Key: u.id                                                                                                             |
| Batches: 1  Memory Usage: 5649kB                                                                                            |
| ->  Gather  (cost=36198.76..39698.83 rows=33334 width=16) (actual time=504.063..521.788 rows=149619 loops=1)                |
| Workers Planned: 2                                                                                                          |
| Workers Launched: 2                                                                                                         |
| ->  Partial HashAggregate  (cost=35198.76..35365.43 rows=16667 width=16) (actual time=502.114..511.672 rows=49873 loops=3)  |
| Group Key: u.id                                                                                                             |
| Batches: 1  Memory Usage: 5649kB                                                                                            |
| Worker 0:  Batches: 1  Memory Usage: 5649kB                                                                                 |
| Worker 1:  Batches: 1  Memory Usage: 5649kB                                                                                 |
| ->  Hash Join  (cost=1923.34..33462.61 rows=347229 width=12) (actual time=18.477..311.918 rows=831217 loops=3)              |
| Hash Cond: (p.author_id = u.id)                                                                                             |
| ->  Parallel Seq Scan on post p  (cost=0.00..28804.67 rows=1041667 width=8) (actual time=0.015..87.856 rows=833333 loops=3) |
| ->  Hash  (cost=1715.00..1715.00 rows=16667 width=8) (actual time=18.378..18.379 rows=49873 loops=3)                        |
| Buckets: 65536 (originally 32768)  Batches: 1 (originally 1)  Memory Usage: 2461kB                                          |
| ->  Seq Scan on user_ u  (cost=0.00..1715.00 rows=16667 width=8) (actual time=0.009..11.232 rows=49873 loops=3)             |
| Filter: (((now())::date - birth_date) < 365)                                                                                |
| Rows Removed by Filter: 127                                                                                                 |
| Planning Time: 0.170 ms                                                                                                     |
| Execution Time: 573.991 ms                                                                                                  |

–û—Å–Ω–æ–≤–Ω–æ–µ –≤—Ä–µ–º—è –∑–∞–Ω–∏–º–∞–µ—Ç —É–∂–µ hash indexed JOINs –∏ –∞–≥–≥—Ä–µ–≥–∞—Ü–∏—è. –û—Å–æ–±–æ –Ω–µ —É—Å–∫–æ—Ä–∏—à—å –∑–∞ —Å—á–µ—Ç –∏–Ω–¥–µ–∫—Å–æ–≤

–ú–æ–∂–Ω–æ —É—Å–∫–æ—Ä–∏—Ç—å —Å –º–∞—Ç–µ—Ä–∏–∞–ª—å–Ω—ã–π view –Ω–∞ SUM rating ü§î

–ê –≤ —Ü–µ–ª–æ–º 500–º—Å –Ω–µ —Ç–∞–∫ —É–∂ —Ç–æ –∏ –¥–æ–ª–≥–æ –ø–æ–∫–∞ —á—Ç–æ —á—Ç–æ–±—ã —É—Å–∫–æ—Ä—è—Ç—å üòÑ –Ω–∞ —Ç–æ–º –∏ –∑–∞–≤–µ—Ä—à–∏–º –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

# 8. –û—Ü–µ–Ω–∏—Ç—å —Ä–∞–∑–º–µ—Ä –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤. –ü—Ä–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ - —Å–æ–∫—Ä–∞—Ç–∏—Ç—å —Ä–∞–∑–º–µ—Ä —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤.

hpemdfwd_indexes=# \di+

## List of relations


| Name                                     | Table               | Access method | Size       |
| ------------------------------------------ | --------------------- | --------------- | ------------ |
| comment_approval_pkey                    | comment_approval    | btree         | 8192 bytes |
| comment_pkey                             | comment             | btree         | 8192 bytes |
| idx_expression_post_approval_change_coal | post_approval       | btree         | 8192 bytes |
| idx_post_approval_post_id                | post_approval       | hash          | 80 kB      |
| idx_post_author_id                       | post                | btree         | 17 MB      |
| idx_post_created                         | post                | btree         | 54 MB      |
| idx_post_edition_edited                  | post_edition        | btree         | 11 MB      |
| idx_post_edition_post_id                 | post_edition        | hash          | 16 MB      |
| idx_post_edition_tags                    | post_edition        | gin           | 600 kB     |
| idx_post_edition_user_id                 | post_edition        | hash          | 16 MB      |
| idx_post_rating                          | post                | btree         | 17 MB      |
| idx_post_status                          | post                | btree         | 17 MB      |
| idx_post_visits_day_date                 | post_visits_per_day | btree         | 3584 kB    |
| idx_post_visits_post_id                  | post_visits_per_day | hash          | 16 MB      |
| idx_post_visits_visits                   | post_visits_per_day | btree         | 3568 kB    |
| idx_user_ratings_ratings                 | user_ratings        | btree         | 2224 kB    |
| one_approval_only_per_comment_for_user   | comment_approval    | btree         | 8192 bytes |
| one_approval_only_per_post_for_user      | post_approval       | btree         | 8192 bytes |
| only_one_visit_counter_per_post          | post_visits_per_day | btree         | 18 MB      |
| post_approval_pkey                       | post_approval       | btree         | 8192 bytes |
| post_edition_pkey                        | post_edition        | btree         | 11 MB      |
| post_pkey                                | post                | btree         | 54 MB      |
| post_visits_per_day_pkey                 | post_visits_per_day | btree         | 11 MB      |
| user__pkey                               | user_               | btree         | 1112 kB    |

–í—ã–≤–æ–¥—ã:

- Btree –Ω–∞ datetime –Ω–∞–º–Ω–æ–≥–æ –±–æ–ª–µ–µ —Ç—Ä–µ–±—É–µ—Ç –º–µ—Å—Ç–∞ —á–µ–º btree –Ω–∞ integer —Å—É–¥—è –ø–æ —Ç–∞–±–ª–∏—Ü—É Post
- Hash –∏–Ω–¥–µ–∫—Å –º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–ª—è—Ç—å –º–µ—Å—Ç–∞ –±–æ–ª—å—à–µ —á–µ–º Btree –ø–æ —Ç–∞–±–ª–∏—Ü—É post_edition –∏ post_visits_per_day

–í–∞—Ä–∏–∞–Ω—Ç—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏?

- datetime –∏–Ω–¥–µ–∫—Å—ã –º–æ–∂–Ω–æ –±—ã –≤—Å–µ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ BRIN –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –º–µ—Å—Ç–∞, –æ–Ω–∏ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –æ–±—ã—á–Ω–æ —Ö–æ—Ä–æ—à–æ –∫–æ—Ä–µ–ª–∏—Ä—É—é—Ç –≤ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–º –ø–ª–∞–Ω–µ –º–µ—Å—Ç–∞
- –∏ –≤—ã–∫–∏–Ω—É–ª Hash, –ø–æ–º–µ–Ω—è–≤ –Ω–∞ Btree

kmtunrkg_indexes=# \di+
List of relations


| Name                                     | Table               | Access method | Size       |
| ------------------------------------------ | --------------------- | --------------- | ------------ |
| comment_approval_pkey                    | comment_approval    | btree         | 8192 bytes |
| comment_pkey                             | comment             | btree         | 8192 bytes |
| idx_expression_post_approval_change_coal | post_approval       | btree         | 8192 bytes |
| idx_post_approval_post_id                | post_approval       | hash          | 80 kB      |
| idx_post_author_id                       | post                | hash          | 88 MB      |
| idx_post_created                         | post                | brin          | 48 kB      |
| idx_post_edition_edited                  | post_edition        | brin          | 48 kB      |
| idx_post_edition_post_id                 | post_edition        | hash          | 16 MB      |
| idx_post_edition_tags                    | post_edition        | gin           | 600 kB     |
| idx_post_edition_user_id                 | post_edition        | hash          | 16 MB      |
| idx_post_rating                          | post                | btree         | 17 MB      |
| idx_post_status                          | post                | btree         | 17 MB      |
| idx_post_visits_day_date                 | post_visits_per_day | brin          | 48 kB      |
| idx_post_visits_post_id                  | post_visits_per_day | hash          | 16 MB      |
| idx_post_visits_visits                   | post_visits_per_day | btree         | 3576 kB    |
| idx_user_ratings_ratings                 | user_ratings        | btree         | 2224 kB    |
| one_approval_only_per_comment_for_user   | comment_approval    | btree         | 8192 bytes |
| one_approval_only_per_post_for_user      | post_approval       | btree         | 8192 bytes |
| only_one_visit_counter_per_post          | post_visits_per_day | btree         | 18 MB      |
| post_approval_pkey                       | post_approval       | btree         | 8192 bytes |
| post_edition_pkey                        | post_edition        | btree         | 11 MB      |
| post_pkey                                | post                | btree         | 54 MB      |
| post_visits_per_day_pkey                 | post_visits_per_day | btree         | 11 MB      |
| user__pkey                               | user_               | btree         | 1112 kB    |
